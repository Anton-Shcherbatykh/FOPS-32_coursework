---
- name: Install and configure Zabbix server with PostgreSQL
  hosts: zabbix
  become: true
  vars:
    zabbix_db_password: "----------"
    zabbix_db_name: "zabbix"
    zabbix_db_user: "zabbix"
    php_timezone: "Europe/Moscow"
    
  tasks:
    - name: "1. Update apt cache"
      apt:
        update_cache: yes
        cache_valid_time: 3600

    - name: "2. Install PostgreSQL and Apache"
      apt:
        name:
          - postgresql
          - postgresql-contrib
          - apache2
        state: present

    - name: "3. Download Zabbix repository package"
      get_url:
        url: https://repo.zabbix.com/zabbix/6.0/ubuntu/pool/main/z/zabbix-release/zabbix-release_6.0-4%2Bubuntu22.04_all.deb
        dest: "/tmp/zabbix-release.deb"
        mode: '0644'

    - name: "4. Install Zabbix repository"
      apt:
        deb: /tmp/zabbix-release.deb
      notify: Update apt cache after repo add

    - name: "5. Install Zabbix components"
      apt:
        name: "{{ packages }}"
        state: installed
      vars:
        packages:
           - zabbix-server-pgsql
           - zabbix-frontend-php
           - php8.2-pgsql
           - zabbix-apache-conf
           - zabbix-sql-scripts
           - zabbix-agent
      notify: Restart Zabbix server

    - name: "6. Configure PHP timezone for Zabbix frontend"
      lineinfile:
        path: /etc/php/8.2/apache2/php.ini
        regexp: '^;?date\.timezone ='
        line: 'date.timezone = {{ php_timezone }}'
      notify: Restart Apache

    - name: "7. Ensure PostgreSQL is running"
      systemd:
        name: postgresql
        state: started
        enabled: yes

    - name: "8. Create Zabbix database user in PostgreSQL"
      community.postgresql.postgresql_user:
        name: "{{ zabbix_db_user }}"
        password: "{{ zabbix_db_password }}"
        role_attr_flags: "CREATEDB,NOSUPERUSER"
        state: present

    - name: "9. Create Zabbix database"
      community.postgresql.postgresql_db:
        name: "{{ zabbix_db_name }}"
        owner: "{{ zabbix_db_user }}"
        encoding: "UTF8"
        lc_collate: "en_US.UTF-8"
        lc_ctype: "en_US.UTF-8"
        template: "template0"
        state: present

    - name: "10. Import Zabbix database schema"
      community.postgresql.postgresql_db:
        name: "{{ zabbix_db_name }}"
        state: restore
        target: /usr/share/zabbix-sql-scripts/postgresql/server.sql.gz
        # Для распаковки gz на лету добавляем параметр:
        target_opts: "-Fc"
      # Альтернатива через команду (если предыдущий метод не работает):
      # command: >
      #   zcat /usr/share/zabbix-sql-scripts/postgresql/server.sql.gz |
      #   sudo -u zabbix psql {{ zabbix_db_name }}
      #   creates: "/tmp/.zabbix_schema_imported"  # Маркер выполнения
      become_user: "{{ zabbix_db_user }}"
      environment:
        PGPASSWORD: "{{ zabbix_db_password }}"

    - name: "11. Configure Zabbix server database connection"
      lineinfile:
        path: /etc/zabbix/zabbix_server.conf
        regexp: '^#?DBPassword='
        line: 'DBPassword={{ zabbix_db_password }}'
        backup: yes
      notify: Restart Zabbix server

    - name: "12. Enable and start services"
      systemd:
        name: "{{ item }}"
        state: started
        enabled: yes
        daemon_reload: yes
      loop:
        - zabbix-server
        - zabbix-agent
        - apache2

  handlers:
    - name: Update apt cache after repo add
      apt:
        update_cache: yes

    - name: Restart Zabbix server
      systemd:
        name: zabbix-server
        state: restarted

    - name: Restart Apache
      systemd:
        name: apache2
        state: restarted
